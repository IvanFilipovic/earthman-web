{"file":"card-CHmn2hqx.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,UAAM,QAAQ,SAAA;AAEI,aAAS,MAAM,MAAM,MAAM,UAAoB;AACjE,UAAM,iBAAiB,SAAS,MAAM,MAAM,MAAM,GAAa;AAE/D,UAAM,eAAe,IAAI,KAAK;AAC9B,UAAM,eAAe,IAAI,EAAE;AAC3B,UAAM,YAAY,IAAI,IAAI;AAK1B,QAAI,SAAS;;;AAmKF,YAAA,WAAAA,eAAAC,WAAA,EAAA,OAAM,sCAAkC,MAAA,CAAA,CAAA,GAAA;AAC/B,YAAAC,mBAAA,0BAAA,EAAA,MAAM,SAAK,MAAA,OAAA,CAAA;gOAMyBC,MAAA,cAAA,CAAc,qVAQHA,MAAA,MAAA,CAAM;UAItDA,MAAA,SAAA,GAAS;;;;;6EAKNA,MAAA,SAAA,IAAS,OAAA,EAAA,SAAA,QAAA,mEAMVA,MAAA,YAAA,CAAY,IAAA,cAAA,6BAEfA,MAAA,YAAA,IAAY,kBAAA,gBAAA,YAAA,CAAA,6BALXA,MAAA,SAAA,IAAS,OAAA,EAAA,SAAA,OAAA,CAAA;UAOPA,MAAA,YAAA,GAAY;;;6DAIgBA,MAAA,MAAA,CAAM,CAAA,SAAA;AAAA;;UAIpCA,MAAA,YAAA,GAAY;qlBAKyBA,MAAA,YAAA,CAAY,CAAA,kBAAA;AAAA;;;;;;;;;;;;;","names":["_ssrRenderAttrs","_mergeProps","_ssrRenderComponent","_unref"],"sources":["../../../../pages/payment/card.vue"],"sourcesContent":["<!-- pages/payment/card.vue -->\n<script setup lang=\"ts\">\nconst route = useRoute()\n\nconst paymentId = computed(() => route.query.payment_id as string)\nconst orderReference = computed(() => route.query.ref as string)\n\nconst isProcessing = ref(false)\nconst errorMessage = ref('')\nconst isLoading = ref(true)\n\nlet stripe: any = null\nlet elements: any = null\nlet clientSecret = ''\nlet amount = 0\nlet currency = 'EUR'\n\n/**\n * Initialize Stripe Elements with client secret from encrypted token\n */\nasync function initializeStripe() {\n  if (!paymentId.value || !orderReference.value) {\n    errorMessage.value = 'Invalid payment session'\n    isLoading.value = false\n    return\n  }\n  \n  if (typeof window === 'undefined') return\n\n  try {\n    // Fetch client secret securely from server (decrypts token)\n    const paymentData = await $fetch<{\n      client_secret: string\n      amount: number\n      currency: string\n    }>('/api/payment/get-client-secret', {\n      method: 'POST',\n      body: {\n        payment_id: paymentId.value\n      }\n    })\n    \n    clientSecret = paymentData.client_secret\n    amount = paymentData.amount\n    currency = paymentData.currency\n\n    // Load Stripe.js\n    const { loadStripe } = await import('@stripe/stripe-js')\n    const config = useRuntimeConfig()\n    \n    stripe = await loadStripe(config.public.stripePublishableKey)\n    \n    if (!stripe) {\n      throw new Error('Failed to load Stripe')\n    }\n\n    // Create Stripe Elements with custom appearance\n    const appearance = {\n      theme: 'stripe' as const,\n      variables: {\n        colorPrimary: '#0040ff',\n        colorBackground: '#e2e2e2',\n        colorText: '#252525',\n        colorDanger: '#C90D00',\n        fontFamily: 'system-ui, sans-serif',\n        borderRadius: '4px',\n      },\n      rules: {\n        '.Input': {\n          border: '1px solid rgba(37, 37, 37, 0.3)',\n          padding: '12px',\n          marginBottom: '8px',\n        },\n        '.Label': {\n          fontSize: '12px',\n          fontWeight: '500',\n          textTransform: 'uppercase',\n        }\n      },\n    }\n\n    elements = stripe.elements({\n      clientSecret,\n      appearance,\n    })\n\n    const paymentElement = elements.create('payment', {\n      layout: 'tabs',\n    })\n\n    paymentElement.mount('#payment-element')\n    isLoading.value = false\n\n  } catch (error: any) {\n    console.error('Error initializing payment:', error)\n    errorMessage.value = error?.data?.message || 'Failed to load payment form'\n    isLoading.value = false\n  }\n}\n\n/**\n * Handle payment submission with server-side verification\n */\nasync function handleSubmit(e: Event) {\n  e.preventDefault()\n  \n  if (!stripe || !elements) {\n    errorMessage.value = 'Payment system not ready'\n    return\n  }\n\n  isProcessing.value = true\n  errorMessage.value = ''\n\n  try {\n    // Confirm payment with Stripe\n    const { error, paymentIntent } = await stripe.confirmPayment({\n      elements,\n      redirect: 'if_required',\n      confirmParams: {\n        return_url: `${window.location.origin}/payment/card/processing`,\n      },\n    })\n\n    if (error) {\n      errorMessage.value = error.message || 'Payment failed'\n      isProcessing.value = false\n      return\n    }\n\n    // Verify payment server-side before redirecting\n    if (paymentIntent && paymentIntent.status === 'succeeded') {\n      const verification = await $fetch<{\n        success: boolean\n        order_reference: string\n        total_price: string\n      }>('/api/payment/verify', {\n        method: 'POST',\n        body: {\n          payment_intent_id: paymentIntent.id,\n          order_reference: orderReference.value,\n          payment_id: paymentId.value\n        }\n      })\n\n      if (verification.success) {\n        await navigateTo({\n          path: '/thank-you',\n          query: {\n            ref: verification.order_reference,\n            total: verification.total_price,\n            payment_intent: 'completed'\n          }\n        })\n      } else {\n        errorMessage.value = 'Payment verification failed. Please contact support.'\n      }\n    } else {\n      errorMessage.value = 'Payment was not completed successfully'\n    }\n    \n  } catch (err: any) {\n    errorMessage.value = err?.data?.message || 'Payment failed. Please try again.'\n    console.error('Payment error:', err)\n  } finally {\n    isProcessing.value = false\n  }\n}\n\nonMounted(() => {\n  if (import.meta.client) {\n    initializeStripe()\n  }\n})\n</script>\n\n<template>\n  <section class=\"min-h-screen bg-background_color\">\n    <AppNavigation :dark=\"false\" />\n\n    <div class=\"max-w-2xl mx-auto px-4 py-12\">\n      <!-- Header -->\n      <div class=\"mb-8\">\n        <h1 class=\"text-2xl uppercase tracking-widest mb-2 text-text_color\">Complete Payment</h1>\n        <p class=\"text-sm text-text_color/70\">Order: {{ orderReference }}</p>\n      </div>\n\n      <!-- Payment Form -->\n      <form id=\"payment-form\" @submit=\"handleSubmit\" class=\"border border-text_color/30 p-6 md:p-8 mb-6\">\n        <!-- Total Amount -->\n        <div class=\"flex justify-between items-center mb-8 pb-6 border-b border-text_color/30\">\n          <span class=\"text-sm uppercase tracking-widest text-text_color font-medium\">Total Amount</span>\n          <span class=\"text-3xl font-semibold text-text_color\">€{{ amount }}</span>\n        </div>\n\n        <!-- Loading Spinner -->\n        <div v-if=\"isLoading\" class=\"flex flex-col items-center justify-center py-20\">\n          <div class=\"animate-spin rounded-full h-10 w-10 border-b-2 border-primary_button_color mb-4\"></div>\n          <p class=\"text-sm text-text_color\">Loading payment form...</p>\n        </div>\n\n        <div v-show=\"!isLoading\" id=\"payment-element\" class=\"mb-6\"></div>\n\n        <button\n          v-show=\"!isLoading\"\n          id=\"submit\"\n          type=\"submit\"\n          :disabled=\"isProcessing\"\n          class=\"w-full btn\"\n          :class=\"isProcessing ? 'btn--disabled' : 'btn--primary'\"\n        >\n          <div v-if=\"isProcessing\" class=\"flex items-center justify-center gap-2\">\n            <div class=\"spinner w-5 h-5 border-2 border-background_color border-t-transparent rounded-full animate-spin\"></div>\n            <span class=\"btn__text\">Processing...</span>\n          </div>\n          <span v-else class=\"btn__text\">Pay €{{ amount }}</span>\n          <span class=\"btn__fill\"></span>\n        </button>\n\n        <div v-if=\"errorMessage\" id=\"payment-message\" class=\"mt-4 p-4 bg-error_text_color/10 border border-error_text_color rounded\">\n          <div class=\"flex items-start gap-2\">\n            <svg class=\"w-5 h-5 text-error_text_color flex-shrink-0 mt-0.5\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\" clip-rule=\"evenodd\" />\n            </svg>\n            <p class=\"text-sm text-error_text_color\">{{ errorMessage }}</p>\n          </div>\n        </div>\n      </form>\n\n      <div class=\"text-center space-y-2\">\n        <div class=\"flex items-center justify-center gap-2 text-success_text_color\">\n          <svg class=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n            <path fill-rule=\"evenodd\" d=\"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z\" clip-rule=\"evenodd\" />\n          </svg>\n          <p class=\"text-sm text-text_color font-medium\">Secure payment powered by Stripe</p>\n        </div>\n        <p class=\"text-xs text-text_color\">All transactions are encrypted and secure</p>\n      </div>\n    </div>\n  </section>\n</template>"],"version":3}