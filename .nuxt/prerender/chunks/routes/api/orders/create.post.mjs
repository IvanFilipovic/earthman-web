import{defineEventHandler as e,readBody as o,createError as t,getHeader as r}from"file:///home/user/earthman-web/node_modules/h3/dist/index.mjs";import{a as s,e as i}from"../../../nitro/nitro.mjs";import"file:///home/user/earthman-web/node_modules/nodemailer/lib/nodemailer.js";import"node:crypto";import"file:///home/user/earthman-web/node_modules/destr/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/hookable/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/ofetch/dist/node.mjs";import"file:///home/user/earthman-web/node_modules/node-mock-http/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/unstorage/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/unstorage/drivers/fs.mjs";import"file:///home/user/earthman-web/node_modules/unstorage/drivers/fs-lite.mjs";import"file:///home/user/earthman-web/node_modules/unstorage/drivers/lru-cache.mjs";import"file:///home/user/earthman-web/node_modules/ohash/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/klona/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/defu/dist/defu.mjs";import"file:///home/user/earthman-web/node_modules/scule/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/unctx/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/radix3/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/@intlify/utils/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/cookie-es/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/vue-router/dist/vue-router.node.mjs";import"node:fs";import"node:url";import"file:///home/user/earthman-web/node_modules/pathe/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/@iconify/utils/lib/index.mjs";import"file:///home/user/earthman-web/node_modules/consola/dist/index.mjs";import"file:///home/user/earthman-web/node_modules/ipx/dist/index.mjs";const m=e(async e=>{var m;const d=s(),a=await o(e),n=["email","country","address","city","postal_code","phone_number","delivery_address","delivery_city","delivery_postal_code","payment_method","shipping_cost"];for(const e of n)if(!a[e])throw t({statusCode:400,message:`Missing required field: ${e}`});if(!["card","paypal"].includes(a.payment_method))throw t({statusCode:400,message:'Invalid payment method. Must be "card" or "paypal"'});if("number"!=typeof a.shipping_cost||a.shipping_cost<0)throw t({statusCode:400,message:"Invalid shipping cost"});const l={email:a.email.trim().toLowerCase(),country:a.country.trim(),address:a.address.trim(),city:a.city.trim(),postal_code:a.postal_code.trim(),phone_number:a.phone_number.trim(),delivery_address:a.delivery_address.trim(),delivery_city:a.delivery_city.trim(),delivery_postal_code:a.delivery_postal_code.trim(),payment_method:a.payment_method,shipping_cost:a.shipping_cost,session_id:a.session_id};try{const o=r(e,"cookie"),t=await $fetch(`${d.apiBase}/api/orders/create/`,{method:"POST",headers:{"Content-Type":"application/json",...o&&{Cookie:o}},body:l});return{payment_id:i({clientSecret:t.client_secret,paypalApprovalUrl:t.paypal_approval_url,orderReference:t.order_reference,amount:parseFloat(t.total_price),currency:"EUR",paymentMethod:t.payment_method,expiresAt:Date.now()+36e5}),order_reference:t.order_reference,total_price:t.total_price,payment_method:t.payment_method}}catch(e){throw console.error("Order creation failed:",e),t({statusCode:e.statusCode||500,message:(null==(m=e.data)?void 0:m.detail)||"Failed to create order"})}});export{m as default};
//# sourceMappingURL=create.post.mjs.map
